name: Build Manager (Parallel)

on:
  push:
  workflow_dispatch:
    inputs:
      package_id:
        required: false
        type: string
        description: "Custom package id (leave empty to use default list)"

jobs:
  # 步骤一：解析要编译的 ID 列表
  prepare-list:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: FrostRime/APatch # 假设列表文件在这个仓库里

      - name: Set Matrix
        id: set-matrix
        run: |
          # 如果输入了 package_id，只用这一个；否则读取文件
          if [ -n "${{ github.event.inputs.package_id }}" ]; then
            JSON_ARRAY=$(echo '["${{ github.event.inputs.package_id }}"]' | jq -c .)
          else
            # 将文件每一行转成 JSON 字符串数组格式
            JSON_ARRAY=$(jq -R -s -c 'split("\n") | map(select(length > 0))' ./default_package_id_list)
          fi
          echo "matrix=$JSON_ARRAY" >> $GITHUB_OUTPUT

  # 步骤二：矩阵并行编译
  build-manager:
    needs: prepare-list
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false # 即使其中一个 ID 编译失败，也不影响其他的
      matrix:
        package_id: ${{ fromJson(needs.prepare-list.outputs.matrix) }}

    name: Build (${{ matrix.package_id }})
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: FrostRime/APatch
          ref: main

      - name: Generate version
        id: parse_version
        run: |
          COMMIT_NUM=$(git rev-list --count HEAD)
          VERSION=$(($COMMIT_NUM + 10200))
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: jetbrains
          java-version: 21
          cache: 'gradle'

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.package_id }}
          shared-key: "rust-build"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Rust toolchain
        run: |
          rustup target install aarch64-linux-android
          if ! command -v cargo-ndk &> /dev/null; then
            cargo install cargo-ndk
          fi

      - name: Replace package_id
        env:
          NEW_PKG: ${{ matrix.package_id }}
          OLD_PKG: me.bmax.apatch
          OLD_DIR: app/src/main/java/me/bmax/apatch
        run: |
          sed -i "s/applicationId[[:space:]]*=[[:space:]]*\".*\"/applicationId = \"$NEW_PKG\"/g" app/build.gradle.kts
          NEW_PKG_DIR: $(echo $NEW_PKG | tr '.' '/')
          NEW_DIR=app/src/main/java/$NEW_PKG_DIR
          sed -i "s/namespace[[:space:]]*=[[:space:]]*\".*\"/namespace = \"$NEW_PKG\"/g" app/build.gradle.kts
          if [ -d "$OLD_DIR" ]; then
            mkdir -p "$NEW_DIR"
            cp -r "$OLD_DIR"/. "$NEW_DIR/"
            rm -rf "app/src/main/java/me"
          fi
          echo "Files moved successfully."
          find app/src/main -type f \( -name "*.kt" -o -name "*.java" -o -name "*.aidl" -o -name "*.xml" \) -exec sed -i "s/me\.bmax\.apatch/$NEW_PKG/g" {} +
          find app/src/apjni -name "*.rs" -type f -exec sed -i 's|me/bmax/apatch|$NEW_PKG_DIR|g' {} +

      - name: Build with Gradle
        run: |
          ./gradlew assembleRelease --build-cache
          echo "BUILD_TOOL_VERSION=$(ls $ANDROID_SDK_ROOT/build-tools/ | tail -n 1)" >> $GITHUB_ENV

      - name: Sign Release
        env:
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          BUILD_TOOLS_VERSION: ${{ env.BUILD_TOOL_VERSION }}
        if: ${{ env.SIGNING_KEY != '' }}
        continue-on-error: true
        uses: kevin-david/zipalign-sign-android-release@v2
        id: sign_app
        with:
          releaseDirectory: app/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
          zipAlign: true

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          # 使用 package_id 区分不同的 artifact 名字
          name: manager-${{ matrix.package_id }}
          path: ${{ steps.sign_app.outputs.signedReleaseFile || 'app/build/outputs/apk/release/*.apk' }}